# Utilisation de l'image Node.js officielle
image: node:20.14.0

# Commandes exÃ©cutÃ©es avant chaque job
before_script:
  - npm install

stages:
  - build
  - test
  - deploy

# Ã‰tape de construction
build:
  stage: build
  script:
    - npm run build

# Ã‰tape de linting
lint:
  stage: test
  script:
    - npm run lint

# Ã‰tape de tests
test:
  stage: test
  script:
    - npm run test

# DÃ©ploiement sur l'environnement de dÃ©veloppement
deploy-dev:
  stage: deploy
  script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - echo "âœ… Setting up SSH agent..."
    - eval $(ssh-agent -s)
    - echo "$EC2_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - echo "âœ… Configuring SSH access..."
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $EC2_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - echo "âœ… Copying files to EC2 instance..."
    - scp -r ./[!.]* $EC2_USERNAME@$EC2_HOST:/home/ubuntu/aws-ci
    - echo "âœ… Files copied successfully."
    - echo "âœ… Deploying application on EC2 instance..."
    - ssh $EC2_USERNAME@$EC2_HOST <<EOF
        set -e
        echo "---------------------------------------"
        echo "ðŸš€ Starting Deployment on EC2 Instance (Development)"
        echo "---------------------------------------"
        echo "ðŸ”„ Navigating to project directory..."
        cd /home/ubuntu/aws-ci
        echo "ðŸ“¦ Installing dependencies..."
        npm install --production=false
        echo "ðŸ”§ Stopping existing Node.js process..."
        pkill -f "node index.js" || true
        echo "ðŸ”„ Starting application in development mode..."
        nohup node index.js > dev.log 2>&1 &
        echo "âœ… Deployment complete! Application is running."
        echo "---------------------------------------"
      EOF
  only:
    - develop



# DÃ©ploiement sur l'environnement de production
deploy-prod:
  stage: deploy
  script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - echo "âœ… Setting up SSH agent..."
    - eval $(ssh-agent -s)
    - echo "$EC2_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - echo "âœ… Configuring SSH access..."
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $EC2_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - echo "âœ… Copying files to EC2 instance..."
    - scp -r ./[!.]* $EC2_USERNAME@$EC2_HOST:/home/ubuntu/aws-ci
    - echo "âœ… Files copied successfully."
    - echo "âœ… Deploying application on EC2 instance..."
    - ssh $EC2_USERNAME@$EC2_HOST <<EOF
        set -e
        echo "---------------------------------------"
        echo "ðŸš€ Starting Deployment on EC2 Instance (Production)"
        echo "---------------------------------------"
        echo "ðŸ”„ Navigating to project directory..."
        cd /home/ubuntu/aws-ci
        echo "ðŸ“¦ Installing dependencies..."
        npm install
        echo "ðŸ”§ Stopping existing Node.js process..."
        pkill -f "node index.js" || true
        echo "ðŸ”„ Starting application in production mode..."
        nohup node index.js > prod.log 2>&1 &
        echo "âœ… Production deployment complete! Application is running."
        echo "---------------------------------------"
      EOF
  only:
    - master

